<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Invoice {{ invoice.invoice_no|default('') }}</title>
    <link rel="stylesheet" href="/static/css/invoice_print.css">
    <style>
        /* Browser-specific overrides for Web Preview */
        body {
            background: #f0f0f0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Font settings are inherited from invoice_print.css but we ensure flex alignment here */
        }
        .page-wrap {
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            width: 210mm;
            min-height: 297mm;
            padding: 20mm; /* Padding handled by .page inside, but we add margin for web look */
            box-sizing: border-box;
            margin-top: 20px;
        }
        .action-toolbar {
            position: sticky;
            top: 0;
            width: 100%;
            max-width: 210mm;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 20px;
            z-index: 1000;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .btn-primary { background: #4f46e5; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn:hover { opacity: 0.9; }

        @media print {
            body { background: white; padding: 0; display: block; }
            .action-toolbar { display: none; }
            .page-wrap { box-shadow: none; margin: 0; width: 100%; }
        }
    </style>
</head>
<body>

    <!-- Action Toolbar -->
    <div class="action-toolbar">
        <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Print</button>
        <button class="btn btn-secondary" onclick="downloadPDF()">üìÑ Download PDF</button>
    </div>

    <div class="page-wrap">
        <div class="page">
            
            <!-- Header Box Wrapper (Table) -->
            <table class="header-box-wrapper">
                <tr>
                    <td>
                        <!-- Top Row -->
                        <table class="top-row">
                            <tr>
                                <td class="top-left">GSTIN: {{ shop.gstin|default('N/A') }}</td>
                                <td class="top-right">Original Copy</td>
                            </tr>
                        </table>

                        <!-- Header Table -->
                        <table class="header-table">
                            <tr>
                                <td class="header-col-left">
                                    <!-- Logo moved to right -->
                                </td>
                                <td class="header-col-center">
                                    <div class="tax-invoice">TAX INVOICE</div>
                                    <div class="shop-name">{{ shop.name|default('Verified Shop') }}</div>
                                    <div class="shop-sub">AN ISO 9001 : 2015 CERTIFIED COMPANY</div>
                                    <div class="shop-address">{{ shop.address|default('') }} {% if shop.city %}, {{shop.city}}{% endif %} - {{ shop.pincode|default('') }}</div>
                                    <div class="shop-contact">
                                        {% if shop.branch_name %}Branch: {{ shop.branch_name }} | {% endif %}
                                        Email: {{ shop.email|default('') }} | Phone: {{ shop.phone|default('') }}
                                    </div>
                                </td>
                                <td class="header-col-right">
                                    <img src="{{ shop.logo_path or '/static/img/logo-w-gradient-new.png' }}" alt="Logo" class="logo-img">
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>

            <!-- Metadata Table -->
            <table class="meta-table">
              <tr>
                <td class="meta-left">
                  <div><span class="meta-key">Invoice No.</span>: {{ invoice.invoice_no|default('N/A') }}</div>
                  <div><span class="meta-key">Date of Invoice</span>: {{ invoice.date.strftime('%d/%m/%Y') if invoice.date else 'N/A' }}</div>
                  <div><span class="meta-key">Place of Supply</span>: {{ invoice.place_of_supply|default('') }}</div>
                  <div style="margin-top:6px; font-weight:700; font-style:italic">Details of Receivers (Billed to) :</div>
                  <div style="font-weight:700">{{ customer.name|default('') }}</div>
                  <div>{{ customer.billing_address|default('') }}</div>
                  <div><span class="meta-key">Party E-mail</span> : {{ customer.email|default('') }}</div>
                  <div><span class="meta-key">GSTIN / UIN</span> : {{ customer.gstin|default('N/A') }}</div>
                  <div><span class="meta-key">Party Code</span> : {{ customer.party_code|default('') }}</div>
                </td>
                <td class="meta-right">
                  <div><span class="meta-key">Eway Bill No</span>: {{ invoice.eway_bill_no|default('') }}</div>
                  <div><span class="meta-key">Eway Bill Dt</span>: {{ invoice.eway_bill_dt or '' }}</div>
                  <div><span class="meta-key">Vehicle No</span>: {{ invoice.vehicle_no|default('') }}</div>
                  <div style="margin-top:6px; font-weight:700; font-style:italic">Details of Consignee (Shipped to) :</div>
                  <div style="font-weight:700">{{ consignee.name|default(customer.name|default('')) }}</div>
                  <div>{{ consignee.shipping_address|default(consignee.billing_address)|default('') }}</div>
                  <div><span class="meta-key">GSTIN / UIN</span> : {{ consignee.gstin|default(customer.gstin|default('N/A')) }}</div>
                  <div><span class="meta-key">Party Code</span> : {{ consignee.party_code|default('') }}</div>
                </td>
              </tr>
            </table>

            <!-- Items Table -->
            <table class="items">
              <thead>
                <tr>
                  <th class="col-sno">S.N</th>
                  <th class="col-desc">Description of Goods</th>
                  <th class="col-hsn">HSN Code</th>
                  <th class="col-tax">Tax %</th>
                  <th class="col-pkts">No. Of Pkts</th>
                  <th class="col-qty">Qty.</th>
                  <th class="col-unit">Unit</th>
                  <th class="col-price">Price (Inc GST)</th>
                  <th class="col-disc">Adv Cash Dis</th>
                  <th class="col-amount">Taxable Amount</th>
                </tr>
              </thead>
              <tbody>
                {% for item in invoice.items %}
                  <tr>
                    <td class="col-sno">{{ loop.index }}</td>
                    <td class="col-desc">{{ item.description|default('') }}</td>
                    <td class="col-hsn">{{ item.hsn_code|default('') }}</td>
                    <td class="col-tax">{{ item.tax_rate|int if item.tax_rate % 1 == 0 else item.tax_rate }}%</td>
                    <td class="col-pkts">{{ item.no_of_pkts|default(0) }}</td>
                    <td class="col-qty">{{ '%.2f'|format(item.qty|default(0)|float) }}</td>
                    <td class="col-unit">
                        {% if item.unit and item.unit|string|replace('.','',1)|int != 0 %}
                            Pcs
                        {% else %}
                            {{ item.unit|default('Pcs') }}
                        {% endif %}
                    </td>
                    <td class="col-price">{{ '%.2f'|format((item.rate|default(0)|float) * (1 + (item.tax_rate|default(0)|float) / 100)) }}</td>
                    <td class="col-disc">{{ '%.2f'|format(item.discount_amount|default(0)|float) }}</td>
                    <td class="col-amount">{{ '%.2f'|format(item.taxable_value|default(0)|float) }}</td>
                  </tr>
                {% endfor %}
                <!-- Total Quantity Row -->
                <tr style="font-weight:bold; background:#f9f9f9;">
                    <td colspan="4" style="text-align:right; padding-right:5px;">Grand Total:</td>
                    <td class="col-pkts" style="text-align:center;"></td>
                    <td class="col-qty">{{ '%.2f'|format(invoice.items|sum(attribute='qty')) }} Pcs.</td>
                    <td colspan="4"></td>
                </tr>
              </tbody>
            </table>

            <!-- Totals Row (Table Structure) -->
            <table class="totals-row">
                <tr>
                    <td style="width: 60%;"></td>
                    <td style="width: 40%;">
                        <table style="width: 100%;">
                            <tr>
                                <td style="text-align: left; font-weight: 600;">Total Amount Before Tax</td>
                                <td style="text-align: right;">{{ '{:,.2f}'.format(taxable_amount|default(0)) }}</td>
                            </tr>
                            <tr>
                                <td style="text-align: left;">CGST Amount</td>
                                <td style="text-align: right;">{{ '{:,.2f}'.format(cgst_amount|default(0)) }}</td>
                            </tr>
                            <tr>
                                <td style="text-align: left;">SGST Amount</td>
                                <td style="text-align: right;">{{ '{:,.2f}'.format(sgst_amount|default(0)) }}</td>
                            </tr>
                            <tr>
                                <td style="text-align: left;">IGST Amount</td>
                                <td style="text-align: right;">{{ '{:,.2f}'.format(igst_amount|default(0)) }}</td>
                            </tr>
                            <tr>
                                <td style="text-align: left;">Add : Freight & Forward</td>
                                <td style="text-align: right;">{{ '{:,.2f}'.format(freight|default(0)) }}</td>
                            </tr>
                            <tr>
                                <td class="grand-total" style="text-align: left;">Grand Total</td>
                                <td class="grand-total" style="text-align: right;">‚Çπ {{ '{:,.2f}'.format(total_amount|default(0)) }}</td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>

            <div class="words">Amount in Words : {{ amount_in_words|default('') }} Only</div>

            <!-- Bottom Row (Bank & QR) -->
            <table class="bottom-row">
              <tr>
                <td class="bottom-left">
                    <div style="margin-bottom: 5px; font-weight: 600;">
                        Previous Balance : {{ invoice.previous_balance|default('0.00') }} Dr<br>
                        Current Balance : {{ invoice.current_balance|default('0.00') }} Dr
                    </div>
                    <div class="bank-details">
                        <strong>Bank Details :</strong> {{ shop.bank_name|default('N/A') }}, IFSC: {{ shop.ifsc_code|default('N/A') }}<br />
                        A/C No: {{ shop.account_number|default('N/A') }}<br />
                        BRANCH: {{ shop.branch_name|default('N/A') }}
                    </div>
                    
                    <div class="terms">
                        <strong>Terms & Conditions</strong>
                        <div style="font-size: 9px; margin-bottom: 2px;">E.& O.E.</div>
                        <ol style="margin-left:14px; margin-top:2px; padding:0;">
                            <li>Goods once sold will not be taken back.</li>
                            <li>Interest @ 18% p.a. will be charged if payment is not made within due date.</li>
                            <li>Subject to {{ shop.city|default('Local') }} Jurisdiction.</li>
                        </ol>
                    </div>
                </td>
                <td class="bottom-right">
                   <div class="qr-box">
                      {% if shop.qr_code_path %}
                        <img src="{{ shop.qr_code_path }}" alt="QR" />
                      {% else %}
                        <img src="/static/img/qr_placeholder.png" alt="QR" />
                      {% endif %}
                   </div>
                </td>
              </tr>
            </table>

            <!-- Signatures -->
            <table class="sign-row">
                <tr>
                    <td style="width:25%; vertical-align:bottom; text-align:left;">
                        <div class="sign-label">Receiver's Signature :</div>
                    </td>
                    <td style="width:20%; vertical-align:bottom; text-align:center;">
                        <div class="sign-label">Prepared By</div>
                    </td>
                    <td style="width:20%; vertical-align:bottom; text-align:center;">
                        <div class="sign-label">Checked By</div>
                    </td>
                    <td style="width:35%; vertical-align:bottom; text-align:right; padding-left: 10px;">
                        <div class="auth-sign">for {{ shop.name|default('Shop') }}</div>
                        <div class="sign-label">Authorised Signatory</div>
                    </td>
                </tr>
            </table>
        
        </div>
    </div>

    <script>
        function downloadPDF() {
            const invoiceId = window.location.pathname.split('/').pop();
            window.location.href = `/invoices/${invoiceId}/pdf`;
        }
    </script>
</body>
</html>